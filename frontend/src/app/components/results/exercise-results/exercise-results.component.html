<div class="results-layout" *ngIf="result">
    <div class="main-content">
        <header class="results-header">
            <div class="breadcrumb">
                <span>Inicio</span> <span class="separator">‚Ä∫</span>
                <span>{{ exercise?.Subcategory?.name || 'Ejercicio' }}</span> <span class="separator">‚Ä∫</span>
                <span class="current">Resultados</span>
            </div>

            <h1 class="page-title">Resultados: {{ exercise?.Subcategory?.name }}</h1>
            <div class="meta-info">
                <span class="icon">üïí</span> Completado el {{ result.timestamp | date:'d MMM, h:mm a' }}
            </div>
        </header>

        <div class="stats-container">
            <div class="stat-card score-card">
                <div class="stat-content">
                    <span class="label">PUNTUACI√ìN</span>
                    <div class="score-value">{{ scorePercentage }}%</div>
                    <div class="badge" [class.pass]="scorePercentage >= 50" [class.fail]="scorePercentage < 50">
                        {{ scorePercentage >= 50 ? 'üëç Aprobado' : 'üëé Suspenso' }}
                    </div>
                </div>
                <div class="circle-progress" [style.--percent]="scorePercentage">
                    <svg viewBox="0 0 36 36">
                        <path class="circle-bg"
                            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        <path class="circle" [attr.stroke-dasharray]="scorePercentage + ', 100'"
                            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    </svg>
                </div>
            </div>

            <div class="stat-card">
                <div class="icon-check">‚úì</div>
                <div class="stat-text">
                    <span class="label">Aciertos</span>
                    <div class="value">{{ result.correct_gaps }}</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="icon-cross">‚úï</div>
                <div class="stat-text">
                    <span class="label">Errores</span>
                    <div class="value">{{ result.total_gaps - result.correct_gaps }}</div>
                </div>
            </div>
        </div>

        <h2 class="section-title">Revisi√≥n detallada</h2>

        <router-outlet></router-outlet>

    </div>

    <aside class="sidebar">
        <div class="ai-card">
            <div class="ai-icon">‚ú®</div>
            <h3>¬øDudas con los errores?</h3>
            <p>Obt√©n una explicaci√≥n detallada y personalizada de tus fallos con nuestra IA.</p>
            <button class="ai-btn" (click)="explainWithIA()" [disabled]="isAnalyzing">
                <span class="btn-icon">üí¨</span> {{ isAnalyzing ? 'Analizando...' : 'Explicar con IA' }}
            </button>
        </div>
        <button class="back-btn" routerLink="/attempts">
            <span class="btn-icon">‚Ü©</span> Volver al inicio
        </button>
        <div class="ai-analysis-card" *ngIf="isAnalyzing || structuredExplanation || htmlExplanation">
            <div class="card-header">
                <span class="icon">ü§ñ</span> AN√ÅLISIS IA <span class="version">v2.4</span>
            </div>
            <div class="analysis-content">
                <div *ngIf="isAnalyzing" class="ai-loading">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
                <div *ngIf="structuredExplanation" class="structured-explanation">
                    <p class="general-feedback">{{ structuredExplanation.general_feedback }}</p>

                    <div class="corrections-list">
                        <div class="correction-item" *ngFor="let correction of structuredExplanation.corrections">
                            <div class="correction-header">
                                <span class="q-id">Gap {{ correction.question_id }}</span>
                                <span class="status-badge" [class.correct]="correction.status === 'correct'"
                                    [class.incorrect]="correction.status === 'incorrect'">{{ correction.status |
                                    uppercase }}</span>
                            </div>
                            <div class="correction-body">
                                <p class="explanation-text">{{ correction.explanation }}</p>
                                <div class="comparison" *ngIf="correction.status === 'incorrect'">
                                    <div class="u-ans">‚ùå {{ correction.user_answer }}</div>
                                    <div class="c-ans">‚úÖ {{ correction.correct_answer }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <p *ngIf="htmlExplanation" class="analysis-text" [innerHTML]="htmlExplanation"></p>
            </div>
        </div>

        <div class="ai-analysis-card" *ngIf="!isAnalyzing && !structuredExplanation && !htmlExplanation">
            <div class="card-header">
                <span class="icon">ü§ñ</span> AN√ÅLISIS IA <span class="version">v2.4</span>
            </div>
            <div class="analysis-content">
                <p class="placeholder-text">Selecciona "Explicar con IA" para ver el an√°lisis...</p>
            </div>
        </div>


    </aside>

</div>