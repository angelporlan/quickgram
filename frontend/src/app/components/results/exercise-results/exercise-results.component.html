<div class="results-layout" *ngIf="result">
    <div class="main-content">
        <header class="results-header">
            <div class="breadcrumb">
                <span>Inicio</span> <span class="separator">‚Ä∫</span>
                <span>{{ exercise?.Subcategory?.name || 'Ejercicio' }}</span> <span class="separator">‚Ä∫</span>
                <span class="current">Resultados</span>
            </div>

            <h1 class="page-title">Resultados: {{ exercise?.Subcategory?.name }}</h1>
            <div class="meta-info">
                <span class="icon">üïí</span> Completado el {{ result.timestamp | date:'d MMM, h:mm a' }}
            </div>
        </header>

        <div class="stats-container">
            <div class="stat-card score-card">
                <div class="stat-content">
                    <span class="label">PUNTUACI√ìN</span>
                    <div class="score-value">{{ scorePercentage }}%</div>
                    <div class="badge" [class.pass]="scorePercentage >= 50" [class.fail]="scorePercentage < 50">
                        {{ scorePercentage >= 50 ? 'üëç Aprobado' : 'üëé Suspenso' }}
                    </div>
                </div>
                <div class="circle-progress" [style.--percent]="scorePercentage">
                    <svg viewBox="0 0 36 36">
                        <path class="circle-bg"
                            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        <path class="circle" [attr.stroke-dasharray]="scorePercentage + ', 100'"
                            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    </svg>
                </div>
            </div>

            <div class="stat-card">
                <div class="icon-check">‚úì</div>
                <div class="stat-text">
                    <span class="label">Aciertos</span>
                    <div class="value">{{ result.correct_gaps }}</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="icon-cross">‚úï</div>
                <div class="stat-text">
                    <span class="label">Errores</span>
                    <div class="value">{{ result.total_gaps - result.correct_gaps }}</div>
                </div>
            </div>
        </div>

        <h2 class="section-title">Revisi√≥n detallada</h2>

        <router-outlet></router-outlet>

    </div>

    <aside class="sidebar">
        <div class="ai-card">
            <div class="ai-icon">‚ú®</div>
            <h3>¬øDudas con los errores?</h3>
            <p>Obt√©n una explicaci√≥n detallada y personalizada de tus fallos con nuestra IA.</p>
            <button class="ai-btn" (click)="explainWithIA()" [disabled]="isAnalyzing">
                <span class="btn-icon">üí¨</span> {{ isAnalyzing ? 'Analizando...' : 'Explicar con IA' }}
            </button>
        </div>

        <div class="ai-analysis-card" *ngIf="isAnalyzing || analysisResult">
            <div class="card-header">
                <span class="icon">ü§ñ</span> AN√ÅLISIS IA <span class="version">v2.4</span>
            </div>
            <div class="analysis-content">
                <div *ngIf="isAnalyzing" class="ai-loading">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
                <!-- Using innerHTML to render line breaks if backend returns \n. 
                     Angular doesn't parse markdown by default, user might need a pipe or just pre-wrap CSS -->
                <p *ngIf="analysisResult" class="analysis-text" [innerHTML]="analysisResult"></p>
            </div>
        </div>

        <div class="ai-analysis-card" *ngIf="!isAnalyzing && !analysisResult">
            <div class="card-header">
                <span class="icon">ü§ñ</span> AN√ÅLISIS IA <span class="version">v2.4</span>
            </div>
            <div class="analysis-content">
                <p class="placeholder-text">Selecciona "Explicar con IA" para ver el an√°lisis...</p>
            </div>
        </div>

        <button class="back-btn">
            <span class="btn-icon" (click)="goHome()">‚Ü©</span> Volver al inicio
        </button>
    </aside>

</div>