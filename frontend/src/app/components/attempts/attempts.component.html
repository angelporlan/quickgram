<div class="page-container">
    <header class="header">
        <div class="header-content">
            <h1>Historial de Ejercicios</h1>
            <p>Revisa tu progreso, analiza tus resultados anteriores y repasa las explicaciones de la IA.</p>
        </div>
        <button class="btn-new-practice" routerLink="/category/use-of-english">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Nueva Práctica
        </button>
    </header>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon-wrapper check">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 11 12 14 22 4"></polyline>
                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-label">COMPLETADOS</span>
                <div class="stat-value">{{ stats.total }}</div>
                <div class="stat-trend">+{{ attempts.length > 0 ? 1 : 0 }} esta semana</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon-wrapper chart">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="20" x2="18" y2="10"></line>
                    <line x1="12" y1="20" x2="12" y2="4"></line>
                    <line x1="6" y1="20" x2="6" y2="14"></line>
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-label">PROMEDIO</span>
                <div class="stat-value">{{ stats.average }}% <span class="level-tag">B2 Alto</span></div>
                <div class="stat-trend">Mejorando en Gramática</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon-wrapper fire">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path
                        d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-2.072-2.143-3-3C5.5 10 3 13.5 3 16a5.5 5.5 0 0 0 11 0c0-1-1-4-3-4">
                    </path>
                    <path d="M14 6c0 2 2 3 3 5 1 2 2 3 2 5a5.5 5.5 0 0 1-11 0"></path>
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-label">RACHA ACTUAL</span>
                <div class="stat-value">{{ stats.streak }} días</div>
                <div class="stat-trend">Sigue así para ganar una insignia</div>
            </div>
        </div>
    </div>

    <!-- Filters Bar -->
    <div class="filters-bar">
        <div class="search-wrapper">
            <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input type="text" placeholder="Buscar por título..." [value]="searchTerm"
                (input)="search($any($event.target).value)">
        </div>

        <div class="date-filter-wrapper">
            <div class="date-filter" (click)="showDateDropdown = !showDateDropdown">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                <span>
                    {{ selectedDateFilter === 'all' ? 'Todos los tiempos' : '' }}
                    {{ selectedDateFilter === 'last30' ? 'Últimos 30 días' : '' }}
                    {{ selectedDateFilter === 'last7' ? 'Últimos 7 días' : '' }}
                    {{ selectedDateFilter === 'today' ? 'Hoy' : '' }}
                </span>
                <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            </div>

            <div class="filter-dropdown" *ngIf="showDateDropdown">
                <div class="filter-option" (click)="setDateFilter('all')" [class.active]="selectedDateFilter === 'all'">
                    Todos los tiempos</div>
                <div class="filter-option" (click)="setDateFilter('last30')"
                    [class.active]="selectedDateFilter === 'last30'">Últimos 30 días</div>
                <div class="filter-option" (click)="setDateFilter('last7')"
                    [class.active]="selectedDateFilter === 'last7'">Últimos 7 días</div>
                <div class="filter-option" (click)="setDateFilter('today')"
                    [class.active]="selectedDateFilter === 'today'">Hoy</div>
            </div>
        </div>

        <div class="category-pills">
            <button *ngFor="let cat of categories" [class.active]="selectedCategory === cat"
                (click)="filterAttempts(cat)" class="pill">
                {{ cat }}
            </button>
        </div>
    </div>

    <div class="list-header">
        <span class="col-exercise">EJERCICIO</span>
        <span class="col-date">FECHA</span>
        <span class="col-result">RESULTADO</span>
        <span class="col-action">ACCIÓN</span>
    </div>

    <div *ngIf="loading" class="loading">Cargando...</div>

    <div *ngIf="!loading && filteredAttempts.length === 0" class="empty-state">
        No se encontraron ejercicios.
    </div>

    <div *ngIf="!loading" class="attempts-list">
        <div *ngFor="let attempt of filteredAttempts" class="attempt-row">
            <div class="col-exercise">
                <div class="exercise-icon-box" [ngClass]="toSlug(attempt.exercise.Subcategory?.name || 'blue')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                    </svg>
                </div>
                <div class="exercise-details">
                    <h3>{{ attempt.exercise.title | slice:0:40 }} {{ attempt.exercise.title.length > 40 ? '...' : '' }}
                    </h3>
                    <span class="sub-tag">{{ attempt.exercise.Subcategory?.name || 'General' }}</span>
                </div>
            </div>

            <div class="col-date">
                {{ attempt.created_at | date:'mediumDate' }}
            </div>

            <div class="col-result">
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill"
                        [style.width.%]="calculatePercentage(attempt.correct_gaps, attempt.total_gaps)"
                        [class.high]="calculatePercentage(attempt.correct_gaps, attempt.total_gaps) >= 80"
                        [class.medium]="calculatePercentage(attempt.correct_gaps, attempt.total_gaps) >= 50 && calculatePercentage(attempt.correct_gaps, attempt.total_gaps) < 80"
                        [class.low]="calculatePercentage(attempt.correct_gaps, attempt.total_gaps) < 50"></div>
                </div>
                <span class="result-text">
                    <span [class.text-green]="calculatePercentage(attempt.correct_gaps, attempt.total_gaps) >= 80">{{
                        attempt.correct_gaps }}</span>
                    / {{ attempt.total_gaps }}
                </span>
            </div>

            <div class="col-action">
                <a [routerLink]="['/results', attempt.id, toSlug(attempt.exercise.Subcategory?.name || 'practica')]"
                    class="btn-arrow">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                        <polyline points="12 5 19 12 12 19"></polyline>
                    </svg>
                </a>
            </div>
        </div>
    </div>

    <!-- Pagination Controls -->
    <div *ngIf="!loading && totalPages > 1" class="pagination-container">
        <button class="pagination-btn" (click)="prevPage()" [disabled]="currentPage === 1">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
            Anterior
        </button>

        <div class="page-numbers">
            <button *ngFor="let page of getPageNumbers()" [class.active]="page === currentPage"
                [class.ellipsis]="page === -1" (click)="page !== -1 && goToPage(page)" [disabled]="page === -1"
                class="page-number">
                {{ page === -1 ? '...' : page }}
            </button>
        </div>

        <button class="pagination-btn" (click)="nextPage()" [disabled]="currentPage === totalPages">
            Siguiente
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
        </button>
    </div>
</div>